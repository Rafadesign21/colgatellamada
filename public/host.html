<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videollamada Colgate - Asesor (Host)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilo adicional para el botón de control */
        #controls { margin-top: 15px; }
        #toggleVideoButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #toggleVideoButton:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>Panel del Asesor</h1>

    <!-- Contenedor de videos sin cambios -->
    <div id="videos-container">
        <div class="video-wrapper">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="video-label">Cámara Local</div>
        </div>
        <div class="video-wrapper">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="video-label">Cámara del Cliente</div>
        </div>
    </div>
    
    <div id="status">Conectando al servidor...</div>

    <!-- NUEVOS CONTROLES -->
    <div id="controls">
        <button id="toggleVideoButton" disabled>Mostrar Video Promocional</button>
    </div>
    <!-- Elemento de video oculto para la promoción -->
    <video id="promoVideo" src="/video.mp4" loop style="display: none;"></video>
    <!-- FIN DE NUEVOS CONTROLES -->

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');
        
        // --- NUEVOS ELEMENTOS ---
        const toggleVideoButton = document.getElementById('toggleVideoButton');
        const promoVideo = document.getElementById('promoVideo');

        let peerConnection;
        let localStream;      // Stream de la cámara/micrófono
        let promoVideoStream; // Stream del video promocional
        let peerId;
        let isShowingPromo = false; // Estado para saber qué se muestra

        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // 1. Iniciar la cámara local
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                localVideo.srcObject = stream;
                statusDiv.textContent = 'Cámara iniciada. Esperando cliente...';
                socket.emit('host-ready');
            })
            .catch(error => console.error('Error al acceder a la cámara:', error));

        // Cuando el servidor nos avisa que un guest está listo
        socket.on('start-call', (guestId) => {
            peerId = guestId;
            statusDiv.textContent = `Cliente conectado. Iniciando llamada...`;
            
            // Habilitar el botón de cambio
            toggleVideoButton.disabled = false;

            peerConnection = new RTCPeerConnection(iceServers);
            
            // Añadir tracks de la CÁMARA por defecto
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { target: peerId, candidate: event.candidate });
                }
            };
            
            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    socket.emit('offer', { target: peerId, offer: peerConnection.localDescription });
                });
        });

        // --- LÓGICA PARA CAMBIAR EL VIDEO ---
        toggleVideoButton.addEventListener('click', () => {
            if (!peerConnection) return; // No hacer nada si no hay llamada

            isShowingPromo = !isShowingPromo; // Cambiar el estado

            if (isShowingPromo) {
                // CAMBIAR A VIDEO PROMOCIONAL
                
                // Si es la primera vez, capturamos el stream del video
                if (!promoVideoStream) {
                    promoVideoStream = promoVideo.captureStream();
                }

                // Pausamos la cámara local para apagar el indicador LED
                localStream.getTracks().forEach(track => track.enabled = false);

                // Reemplazamos las pistas de audio y video en la conexión
                const videoTrack = promoVideoStream.getVideoTracks()[0];
                const audioTrack = promoVideoStream.getAudioTracks()[0];
                
                replaceTrack(videoTrack, 'video');
                replaceTrack(audioTrack, 'audio');

                promoVideo.play();
                toggleVideoButton.textContent = 'Mostrar Cámara';
                statusDiv.textContent = 'Mostrando video promocional al cliente.';

            } else {
                // CAMBIAR DE VUELTA A LA CÁMARA
                promoVideo.pause();

                // Re-habilitamos las pistas de la cámara
                localStream.getTracks().forEach(track => track.enabled = true);

                const videoTrack = localStream.getVideoTracks()[0];
                const audioTrack = localStream.getAudioTracks()[0];
                
                replaceTrack(videoTrack, 'video');
                replaceTrack(audioTrack, 'audio');
                
                toggleVideoButton.textContent = 'Mostrar Video Promocional';
                statusDiv.textContent = 'Llamada en curso.';
            }
        });

        // Función auxiliar para reemplazar una pista en la conexión
        function replaceTrack(newTrack, kind) {
            const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === kind);
            if (sender) {
                sender.replaceTrack(newTrack);
            }
        }

        // El resto de los manejadores de eventos no cambian
        socket.on('answer', (data) => {
            statusDiv.textContent = 'Llamada en curso.';
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        });

        socket.on('ice-candidate', (data) => {
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });

        socket.on('peer-disconnected', () => {
            statusDiv.textContent = 'El cliente se ha desconectado. Esperando uno nuevo...';
            remoteVideo.srcObject = null;
            toggleVideoButton.disabled = true;
            toggleVideoButton.textContent = 'Mostrar Video Promocional';
            isShowingPromo = false;
            promoVideo.pause();
            if (peerConnection) {
                peerConnection.close();
            }
            socket.emit('host-ready');
        });

        socket.on('connect', () => {
            statusDiv.textContent = 'Conectado al servidor. Iniciando cámara...';
        });
    </script>
</body>
</html>
